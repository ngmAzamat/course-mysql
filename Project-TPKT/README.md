### –ß—Ç–æ —Ç–∞–∫–æ–µ TPKT

TPKT: —ç—Ç–æ —Ç–∞–∫–∞—è –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–¥ TCP, –æ–Ω–∞ –Ω—É–∂–Ω–∞ —á—Ç–æ –±—ã –Ω–µ–∫–æ–Ω—Ç–æ—Ä—ã–µ –ø—Ä–∏–µ–º—É—Å—á–µ—Å—Ç–≤–∞ UDP –ø–æ—è–≤–∏–ª–∏—Å—å –∏ –≤ TCP.

1. UDP: —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –±—É–ª—ã—Ç–∫–∏ —Å –≤–æ–¥–æ–π
2. TCP: —ç—Ç–æ –ø–æ—Ç–æ–∫, —Ç—Ä—É–±–∞ –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç—É —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –±—É—Ç—ã–ª–∫–∏
3. TCP —Å TPKT: —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –±—É—Ç—ã–ª–∫–∏ —Å –≤–æ–¥–æ–π

### –ü–æ—á–µ–º—É –Ω–µ UDP

UDP: –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–µ–Ω, –ø–æ–¥—Ö–æ–¥–∏—Ç –º–∞–∫—Å–∏–º—É–º –¥–ª—è youtube –≥–¥–µ –Ω–µ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –≤–∞–∂–µ–Ω –∫–∞–∂–¥—ã–π –∫–∞–¥–æ
TCP: –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–µ–Ω, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —á–∞—Ç–∞ –≥–¥–µ –∫–∞–∂–¥–∞—è –±—É–∫–≤–∞ –∏–ª–∏ —Å–ª–æ–≤–æ –≤–∞–∂–Ω–æ —á—Ç–æ –±—ã –Ω–µ –ø–æ–Ω—è–ª–∏ —Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω–∞–¥–æ

### TPKT

—Ç—É—Ç –º—ã –¥–µ–ª–∞–µ–º 4 –±–∞–π—Ç–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:

- 1 –±–∞–π—Ç - version
- 1 –±–∞–π—Ç - reserver
- 2 –±–∞–π—Ç–∞ - –¥–ª–∏–Ω–Ω–∞ –ø–∞–∫–µ—Ç–∞

–∏ –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É –≤ –¥–ª–∏–Ω–Ω–µ –ø–∞–∫–µ—Ç–∞ –º—ã –ø–æ —Å—É—Ç–∏ —Ä–µ—à–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–¥–ª–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ—Ç–æ–º –æ–Ω–æ –∑–∞–µ—Ä—à–∏—Ç—Å—è –∏ –¥—Ä—É–≥–æ–µ –∏–¥–µ—Ç.



### –ü—Ä–æ—ç–∫—Ç TPKT

- –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —á–∞—Ç, –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä –∏ –∫–ª–∏–µ–Ω—Ç, –∏ —Ä–∞–∑–¥–µ–ª—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ–≤—ã–π —Å—Ç–æ—Ä–æ–π, –Ω–∞ ruby
- –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ —á–∞—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π –¥–ª—è –º–Ω–æ–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–æ–±–∞–≤–∏—Ç—å TPKT, —Å–ª–µ–ª–∞—Ç—å –º–Ω–æ–≥–æ—Å—Ç–æ—Ä—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –≠—Ç–∞–ø I: –û–¥–Ω–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π TPKT-—á–∞—Ç

##### –ß—Ç–æ –¥–µ–ª–∞–µ–º

- –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏ ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∏ –≤—ã–≤–æ–¥–∏—Ç ‚Üí –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –û–∫: <—Å–æ–æ–±—â–µ–Ω–∏–µ>
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TPKT –¥–ª—è —á—ë—Ç–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π


##### server.rb

```ruby
require 'socket' # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Ruby –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å TCP-—Å–æ–∫–µ—Ç–∞–º–∏

def read_tpkt(socket) # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ TPKT-–ø–∞–∫–µ—Ç–∞ –∏–∑ TCP-–ø–æ—Ç–æ–∫–∞
  header = socket.read(4) # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 –±–∞–π—Ç–∞ ‚Äî —ç—Ç–æ TPKT-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (version, reserved, length)
  return nil unless header && header.bytesize == 4 # –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 4 –±–∞–π—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ
  version, _, hi, lo = header.bytes.unpack("C4") # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –±–∞–π—Ç—ã: version=1, reserved=2, hi=3, lo=4
  raise "–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è TPKT" unless version == 3 # –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤–µ—Ä—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 3
  length = (hi << 8) + lo # –°–∫–ª–µ–∏–≤–∞–µ–º hi –∏ lo –≤ 16-–±–∏—Ç–Ω—É—é –¥–ª–∏–Ω—É: –¥–ª–∏–Ω–∞ = (hi * 256) + lo
  socket.read(length - 4) # –ß–∏—Ç–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–∞–π—Ç—ã –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ (–¥–ª–∏–Ω–∞ - 4 –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö –±–∞–π—Ç–∞)
end

def send_tpkt(socket, data) # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –æ–±—ë—Ä—Ç–∫–æ–π –≤ TPKT-–∑–∞–≥–æ–ª–æ–≤–æ–∫
  length = data.bytesize + 4 # –û–±—â–∞—è –¥–ª–∏–Ω–∞ –ø–∞–∫–µ—Ç–∞ = —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö + 4 –±–∞–π—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
  header = [3, 0, length >> 8, length & 0xFF].pack("C4") 
  # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫:
  # version = 3, reserved = 0
  # –∑–∞—Ç–µ–º –¥–ª–∏–Ω–∞ –≤ –¥–≤—É—Ö –±–∞–π—Ç–∞—Ö: —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—à–∏–π –±–∞–π—Ç (>> 8), –ø–æ—Ç–æ–º –º–ª–∞–¥—à–∏–π (& 0xFF)
  socket.write(header + data) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–∞–Ω–Ω—ã–µ –≤ TCP-—Å–æ–∫–µ—Ç
end

server = TCPServer.new('localhost', 4000) # —Å–æ–∑–¥–∞–Ω–∏–µ–º TCP –Ω–∞ localhost:4000 - –º—ã —Å–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª(—Ç—Ä—É–±—É) —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —Å–µ—Ä–≤–µ—Ä–∞
puts "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 4000" # –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ TCP –Ω–∞ localhost:4000

client = server.accept 
# –°–µ—Ä–≤–µ—Ä "–≤–∏—Å–∏—Ç", –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è
# –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º—ã –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç `client` –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º
puts "–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!" # –∫–æ–≥–¥–∞ –∫—Ç–æ —Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ


loop do # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –ø—Ä–∏—ë–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  msg = read_tpkt(client) # –ß–∏—Ç–∞–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
  break if msg.nil? || msg.strip.downcase == "exit" 
  # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –∏–ª–∏ –Ω–∞–ø–∏—Å–∞–ª "exit" ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
  puts "–ö–ª–∏–µ–Ω—Ç: #{msg}" # –ü–µ—á–∞—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  send_tpkt(client, "–û–∫: #{msg}") # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ TPKT
end

puts "–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è." # –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
client.close # –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è
```

##### client.rb

```ruby
require 'socket' # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Ruby –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å TCP-—Å–æ–∫–µ—Ç–∞–º–∏

def read_tpkt(socket)
  header = socket.read(4) # –ß–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  version, _, hi, lo = header.bytes.unpack("C4") # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –±–∞–π—Ç—ã
  length = (hi << 8) + lo # –°—á–∏—Ç–∞–µ–º –¥–ª–∏–Ω—É
  socket.read(length - 4) # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ
end

def send_tpkt(socket, data) # –Ω–µ –∑–Ω–∞—é
  length = data.bytesize + 4 # –Ω–µ –∑–Ω–∞—é
  header = [3, 0, length >> 8, length & 0xFF].pack("C4") # –Ω–µ –∑–Ω–∞—é
  socket.write(header + data) # –Ω–µ –∑–Ω–∞—é
end

socket = TCPSocket.new('localhost', 4000)  # –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ TCP localhost:4000 - –º—ã —Å–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª(—Ç—Ä—É–±—É) —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
puts "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–ª–∏ 'exit'):" # –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–∫–ª—é—á–µ–Ω–∏–µ –∫ TCP localhost:4000, –¥–µ–ª–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞

loop do # –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–ø–∏—à–µ—Ç 'exit'
  print "> " # –ü–µ—á–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
  input = gets # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  break if input.nil? # –ï—Å–ª–∏ –≤–≤–æ–¥–∞ –Ω–µ—Ç (Ctrl+D –∏–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ stdin)
  send_tpkt(socket, input.chomp) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –±–µ–∑ \n
  response = read_tpkt(socket) # –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
  puts "–°–µ—Ä–≤–µ—Ä: #{response}"
end

socket.close # –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
puts "–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞" # –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è
```

##### –¢–µ—Ä–º–∏–Ω–∞–ª

–û—Ç–∫—Ä–æ–π –¥–≤–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:
–í –ø–µ—Ä–≤–æ–º: `ruby server.rb`
–í–æ –≤—Ç–æ—Ä–æ–º: `ruby client.rb`
–ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–ª–∏–µ–Ω—Ç–µ ‚Üí –æ–Ω–∏ –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –ø–æ TPKT ‚Üí —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç.

#### –≠—Ç–∞–ø II: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å

##### üß† –¶–µ–ª—å

–°–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —á–∞—Ç-—Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π:

- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ;
- —á–∏—Ç–∞–µ–º –∏ –ø–∏—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ TPKT;
- –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º (–∫–∞–∫ –≤ –æ–±—â–µ–º —á–∞—Ç–µ).

##### üß© –ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è

–°–µ—Ä–≤–µ—Ä:

- –¥–æ–±–∞–≤–ª—è–µ–º Thread.new –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞;
- —Ö—Ä–∞–Ω–∏–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤;
- –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç —á—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç ‚Üí –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –¥—Ä—É–≥–∏–º.

–ö–ª–∏–µ–Ω—Ç:

- –∑–∞–ø—É—Å–∫–∞–µ–º –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, –¥—Ä—É–≥–æ–π –¥–ª—è —á—Ç–µ–Ω–∏—è;
- —á–∏—Ç–∞–µ–º/–ø–∏—à–µ–º —á–µ—Ä–µ–∑ TPKT, –∫–∞–∫ —Ä–∞–Ω—å—à–µ.

##### server.rb

```ruby
require 'socket'
clients = []

def read_tpkt(socket)
  header = socket.read(4)
  return nil unless header && header.bytesize == 4
  version, _, hi, lo = header.unpack("C4")
  length = (hi << 8) + lo
  socket.read(length - 4)
rescue EOFError, Errno::ECONNRESET, Errno::EPIPE
  nil
end
  

def send_tpkt(socket, data)
  length = data.bytesize + 4
  header = [3, 0, length >> 8, length & 0xFF].pack("C4")
  socket.write(header + data)
rescue
  # –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∏–µ–Ω—Ç –≤—ã—à–µ–ª)
end

server = TCPServer.new('192.168.100.90', 4000)
puts "–°–µ—Ä–≤–µ—Ä TPKT –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 4000"

loop do
  client = server.accept
  clients << client
  puts "–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è (–≤—Å–µ–≥–æ: #{clients.size})"

  Thread.new(client) do |sock|
    begin
      nickname = "–ì–æ—Å—Ç—å#{sock.object_id.to_s[-3..]}"
      send_tpkt(sock, "–ü—Ä–∏–≤–µ—Ç, —Ç—ã #{nickname}")
  
      loop do
        msg = read_tpkt(sock)
        break if msg.nil? || msg.strip.downcase == "exit"
  
        msg = msg.force_encoding("UTF-8") if msg
  
        if msg.strip.start_with?("/nick ")
          new_nick = msg.strip[6..].strip
          if new_nick.empty?
            send_tpkt(sock, "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
          else
            old_nick = nickname
            nickname = new_nick
            send_tpkt(sock, "–¢—ã —Ç–µ–ø–µ—Ä—å: #{nickname}")
            clients.each do |cl|
              next if cl == sock
              send_tpkt(cl, "#{old_nick} —Ç–µ–ø–µ—Ä—å –∏–∑–≤–µ—Å—Ç–µ–Ω –∫–∞–∫ #{nickname}")
            end
          end
          next
        end
  
        puts "#{nickname}: #{msg}"
        clients.each do |cl|
          next if cl == sock
          send_tpkt(cl, "#{nickname}: #{msg}")
        end
      end
    rescue => e
      puts "‚ùå –û—à–∏–±–∫–∞: #{e.class} ‚Äî #{e.message}"
    ensure
      puts "#{nickname} –æ—Ç–∫–ª—é—á–∏–ª—Å—è"
      clients.delete(sock)
      sock.close
    end
  end  
end
```

##### client.rb

```ruby
require 'socket'

def read_tpkt(socket)
    header = socket.read(4)
    return nil unless header && header.bytesize == 4
    version, _, hi, lo = header.unpack("C4")
    length = (hi << 8) + lo
    payload = socket.read(length - 4)
    return nil if payload.nil?
    payload
  rescue IOError, EOFError, Errno::ECONNRESET
    nil
  end

def send_tpkt(socket, data)
  length = data.bytesize + 4
  header = [3, 0, length >> 8, length & 0xFF].pack("C4")
  socket.write(header + data)
end

socket = TCPSocket.new('192.168.100.90', 4000)
puts "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–ª–∏ 'exit'):"

# –ü—Ä–∏—ë–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
Thread.new do
  loop do
    msg = read_tpkt(socket)
    break if msg.nil?
    puts "\n#{msg}"
    print "> "
  end
end

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
loop do
  print "> "
  input = gets
  break if input.nil? || input.strip.downcase == "exit"
  send_tpkt(socket, input.chomp)
end

socket.close
puts "–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"
```

##### –¢–µ—Ä–º–∏–Ω–∞–ª

–û—Ç–∫—Ä–æ–π –æ–¥–∏–Ω —Ç–µ—Ä–º–∏–Ω–∞–ª: `ruby server.rb`
–û—Ç–∫—Ä–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥—Ä—É–≥–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤: `ruby client.rb`
–ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –¥—Ä—É–≥–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º.